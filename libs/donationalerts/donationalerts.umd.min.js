!function(e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).DonationAlerts=e()}(function(){class e{constructor(e,t="https://st.aniby.net/"){this.userToken=e;e=new URL(t);this.host=e.protocol+"//"+e.hostname+(e.port?":"+e.port:""),this.accessToken=null,this.userId=null,this.centrifuge=null}init=async()=>{this.centrifuge&&this.centrifuge.disconnect(),this.accessToken=await this._getAccessToken(this.userToken);var{id:e,socket_connection_token:t}=await this._getDonationUserInfo(),e=(this.userId=e,await this._getCentrifugeConfig()).endpoint;this.centrifuge=new Centrifuge(e,{pingInterval:15e3,ping:!0,minRetry:0,maxRetry:3e4,websocket:WebSocket,onPrivateSubscribe:(e,t)=>{this._subscribeRequest(e.data.channels,e.data.client).then(e=>e.json()).then(e=>{e=e.channels;t({status:200,data:{channels:e.map(e=>({channel:e.channel,token:e.token}))}})}).catch(e=>console.error(e))}}),this.centrifuge.setToken(t),this.centrifuge.connect()};subscribeGoals=t=>{this.centrifuge.subscribe("$goals:goal_"+this.userId,({data:e})=>{t(e)})};subscribeRoulette=t=>{this.centrifuge.subscribe("$widgets:roulette_widgets_"+this.userId,({data:e})=>{t(e)})};getGoalData=async e=>(await(await fetch(this.host+`/da/goal/info?id=${e}&accessToken=`+this.accessToken)).json()).data;_getDonationUserInfo=async()=>(await(await fetch(this.host+"/da/user/widget?accessToken="+this.accessToken)).json()).data;_getCentrifugeConfig=async()=>(await(await fetch("https://www.donationalerts.com/api/v1/env/front")).json()).data.centrifugo;_getAccessToken=async e=>{e="https://www.donationalerts.com/api/v1/token/widget?"+new URLSearchParams({token:e}).toString();return(await(await fetch(e,{method:"GET"})).json()).data.token};_subscribeRequest=(e,t)=>{var n=new Headers,e=(n.append("Accept","application/json"),n.append("Authorization","Bearer "+this.accessToken),n.append("Content-Type","application/json"),{channels:e,client:t});return fetch("https://www.donationalerts.com/api/v1/centrifuge/subscribe",{method:"POST",headers:n,body:JSON.stringify(e)})}}return e});
